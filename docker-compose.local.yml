# =============================================================================
# Local development environment for Ship API
# =============================================================================
# Start the full stack:
#   pnpm docker:up
#
# Services:
#   - PostgreSQL: localhost:5433 (mapped to avoid conflict with local PostgreSQL)
#   - API Server: localhost:3000
#     - Swagger UI: http://localhost:3000/api/docs/
#     - OpenAPI JSON: http://localhost:3000/api/openapi.json
#     - Health check: http://localhost:3000/health
#   - Web Frontend: localhost:5173
#
# The API automatically runs migrations and seeds on startup.
# =============================================================================

services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: ship_dev
      POSTGRES_USER: ship
      POSTGRES_PASSWORD: ship_dev_password
    ports:
      - "5433:5432"  # Use 5433 to avoid conflict with local PostgreSQL
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ship -d ship_dev"]
      interval: 5s
      timeout: 3s
      retries: 10

  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      PORT: 3000
      DATABASE_URL: postgres://ship:ship_dev_password@postgres:5432/ship_dev
      SESSION_SECRET: local-dev-session-secret-not-for-production
      CORS_ORIGIN: http://localhost:5173
    depends_on:
      postgres:
        condition: service_healthy

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:3000
    depends_on:
      - api

volumes:
  postgres_data:

option_settings:
  # Environment variables (fetched from SSM Parameter Store at runtime)
  aws:elasticbeanstalk:application:environment:
    NODE_ENV: production
    PORT: "8080"
    # Database URL - fetched from SSM at container startup
    DATABASE_URL: '`{"Ref": "AWSEBSSMDatabaseUrl"}`'
    # CORS origin - fetched from SSM at container startup
    CORS_ORIGIN: '`{"Ref": "AWSEBSSMCorsOrigin"}`'

  # Health check configuration
  aws:elasticbeanstalk:environment:process:default:
    HealthCheckPath: /health
    HealthCheckInterval: 30
    HealthCheckTimeout: 5
    UnhealthyThresholdCount: 3
    HealthyThresholdCount: 3

  # ALB configuration for WebSocket support
  aws:elasticbeanstalk:environment:
    LoadBalancerType: application

  # Enable sticky sessions for WebSocket
  aws:elbv2:listenerrule:default:
    PathPatterns: /*
    Priority: 1

  aws:elasticbeanstalk:environment:process:default:
    StickinessEnabled: true
    StickinessLBCookieDuration: 86400

# SSM parameter references
Resources:
  AWSEBSSMDatabaseUrl:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /ship/dev/DATABASE_URL

  AWSEBSSMCorsOrigin:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /ship/dev/CORS_ORIGIN

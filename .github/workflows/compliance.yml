# Security compliance checks that cannot be bypassed with --no-verify
# This is the enforcement layer - local hooks are convenience, CI is mandatory

name: Compliance

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  secrets-scan:
    name: Secrets Scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for scanning all commits in PR

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Verify that compliance was run locally (detects --no-verify bypasses)
  attestation-check:
    name: Attestation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for ATTESTATION.md
        run: |
          if [ ! -f ATTESTATION.md ]; then
            echo "::error::ATTESTATION.md is missing. Run 'comply opensource' locally before committing."
            exit 1
          fi

          # Check attestation is recent (within last 30 days)
          ATTEST_DATE=$(grep -oP 'date: \K[0-9-]+' ATTESTATION.md | head -1)
          if [ -z "$ATTEST_DATE" ]; then
            echo "::error::ATTESTATION.md is malformed - missing date field"
            exit 1
          fi

          ATTEST_EPOCH=$(date -d "$ATTEST_DATE" +%s 2>/dev/null || date -j -f "%Y-%m-%d" "$ATTEST_DATE" +%s)
          NOW_EPOCH=$(date +%s)
          DAYS_OLD=$(( (NOW_EPOCH - ATTEST_EPOCH) / 86400 ))

          if [ $DAYS_OLD -gt 30 ]; then
            echo "::warning::ATTESTATION.md is $DAYS_OLD days old. Consider re-running 'comply opensource'."
          fi

          echo "Attestation check passed (dated: $ATTEST_DATE, $DAYS_OLD days ago)"
